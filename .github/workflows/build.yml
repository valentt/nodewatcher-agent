name: Build OpenWrt Packages

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"
  TARGET: "ath79"
  SUBTARGET: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout nodewatcher-agent
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build SDK Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.builder
          push: false
          load: true
          tags: nodewatcher-sdk:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build packages in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/src nodewatcher-sdk:latest /bin/bash -c '
            set -e
            cd /home/builder/sdk

            # Create package directory
            mkdir -p package/nodewatcher-agent/src
            cp -r /src/* package/nodewatcher-agent/src/

            # Create OpenWrt Makefile
            cat > package/nodewatcher-agent/Makefile << '\''MAKEFILE_EOF'\''
            include $(TOPDIR)/rules.mk

            PKG_NAME:=nodewatcher-agent
            PKG_VERSION:=2024-12-23
            PKG_RELEASE:=1

            PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)
            CMAKE_INSTALL:=1
            PKG_BUILD_PARALLEL:=1

            include $(INCLUDE_DIR)/package.mk
            include $(INCLUDE_DIR)/cmake.mk

            define Package/nodewatcher-agent/default
              SECTION:=utils
              CATEGORY:=Base system
              TITLE:=Nodewatcher agent daemon
              DEPENDS:=+libubus +libubox +libjson-c
            endef

            define Package/nodewatcher-agent
              $(Package/nodewatcher-agent/default)
              DEPENDS+= +libuci +libblobmsg-json
            endef

            define Package/nodewatcher-agent/description
              Nodewatcher agent daemon
            endef

            define Build/Prepare
            	mkdir -p $(PKG_BUILD_DIR)
            	$(CP) $(CURDIR)/src/* $(PKG_BUILD_DIR)/
            endef

            define Package/nodewatcher-agent/install
            	$(INSTALL_DIR) $(1)/usr/bin
            	$(INSTALL_BIN) $(PKG_BUILD_DIR)/nodewatcher-agent $(1)/usr/bin/nodewatcher-agent
            	$(INSTALL_DIR) $(1)/usr/lib
            	$(INSTALL_BIN) $(PKG_BUILD_DIR)/libnodewatcher-agent-common.so $(1)/usr/lib/
            endef

            # Modules
            define BuildModule
              define Package/nodewatcher-agent-mod-$(1)
                $(Package/nodewatcher-agent/default)
                TITLE+= ($(1) module)
                DEPENDS+=nodewatcher-agent $(2)
              endef
              define Package/nodewatcher-agent-mod-$(1)/install
            	$(INSTALL_DIR) $$(1)/usr/lib/nodewatcher-agent
            	$(INSTALL_BIN) $(PKG_BUILD_DIR)/$(1).so $$(1)/usr/lib/nodewatcher-agent/
              endef
              $$(eval $$(call BuildPackage,nodewatcher-agent-mod-$(1)))
            endef

            $(eval $(call BuildPackage,nodewatcher-agent))
            $(eval $(call BuildModule,general,))
            $(eval $(call BuildModule,resources,))
            $(eval $(call BuildModule,interfaces,))
            $(eval $(call BuildModule,keys_ssh,))
            $(eval $(call BuildModule,clients,))
            $(eval $(call BuildModule,routing_babel,))
            $(eval $(call BuildModule,routing_olsr,))
            $(eval $(call BuildModule,meshpoint,))
            MAKEFILE_EOF

            # Configure
            cat >> .config << EOF
            CONFIG_SIGNED_PACKAGES=n
            CONFIG_PACKAGE_nodewatcher-agent=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-general=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-resources=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-interfaces=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-keys_ssh=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-clients=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-routing_babel=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-routing_olsr=m
            CONFIG_PACKAGE_nodewatcher-agent-mod-meshpoint=m
            EOF
            make defconfig

            # Build
            make package/nodewatcher-agent/compile V=s -j$(nproc) || make package/nodewatcher-agent/compile V=s -j1

            # Copy results
            mkdir -p /src/packages
            find bin -name "nodewatcher*.ipk" -exec cp {} /src/packages/ \;
            ls -la /src/packages/
          '

      - name: List built packages
        run: |
          echo "=== Built packages ==="
          ls -la packages/ || echo "No packages found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nodewatcher-agent-packages-${{ env.TARGET }}-${{ env.SUBTARGET }}
          path: packages/*.ipk
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*.ipk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
