name: Build OpenWrt Packages

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"
  TARGET: "ath79"
  SUBTARGET: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout nodewatcher-agent
        uses: actions/checkout@v4
        with:
          path: nodewatcher-agent

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gawk gettext git libncurses5-dev \
            libssl-dev python3 rsync unzip wget xz-utils zlib1g-dev zstd

      - name: Download OpenWrt SDK
        run: |
          SDK_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${TARGET}/${SUBTARGET}/openwrt-sdk-${OPENWRT_VERSION}-${TARGET}-${SUBTARGET}_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          echo "Downloading SDK from: ${SDK_URL}"
          wget -q "${SDK_URL}" -O sdk.tar.zst
          tar --zstd -xf sdk.tar.zst
          mv openwrt-sdk-* sdk

      - name: Setup feeds
        run: |
          cd sdk
          # Add nodewatcher feed
          echo "src-git nodewatcher https://github.com/valentt/firmware-packages-opkg.git" >> feeds.conf.default
          # Update nodewatcher and base feeds
          ./scripts/feeds update nodewatcher || true
          # Install nodewatcher-agent with dependencies
          ./scripts/feeds install -a -p nodewatcher || true

      - name: Download and install dependencies
        run: |
          cd sdk
          STAGING_DIR="staging_dir/target-mips_24kc_musl"
          PKG_BASE="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/packages/mips_24kc/base"
          TARGET_BASE="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${TARGET}/${SUBTARGET}/packages"

          # Create directories
          mkdir -p tmp_pkgs
          mkdir -p "${STAGING_DIR}/usr/lib" "${STAGING_DIR}/usr/include"

          # Download required packages
          echo "Downloading dependency packages..."
          wget -q "${PKG_BASE}/libubox_2024-09-16-9e52171d-1_mips_24kc.ipk" -O tmp_pkgs/libubox.ipk || true
          wget -q "${PKG_BASE}/libubus_2024-09-01-9913aa61-1_mips_24kc.ipk" -O tmp_pkgs/libubus.ipk || true
          wget -q "${PKG_BASE}/libuci_2024-10-10-c8d13d65-1_mips_24kc.ipk" -O tmp_pkgs/libuci.ipk || true
          wget -q "${PKG_BASE}/libjson-c5_0.18-1_mips_24kc.ipk" -O tmp_pkgs/libjson-c.ipk || true
          wget -q "${PKG_BASE}/libblobmsg-json_2024-09-16-9e52171d-1_mips_24kc.ipk" -O tmp_pkgs/libblobmsg-json.ipk || true
          wget -q "${TARGET_BASE}/libiwinfo_2024-10-20-c45bf3fc-1_mips_24kc.ipk" -O tmp_pkgs/libiwinfo.ipk || true
          wget -q "${PKG_BASE}/libcurl4_8.10.1-1_mips_24kc.ipk" -O tmp_pkgs/libcurl.ipk || true

          # Extract and install packages
          for pkg in tmp_pkgs/*.ipk; do
            if [ -f "$pkg" ]; then
              echo "Extracting $pkg..."
              mkdir -p tmp_extract
              cd tmp_extract
              ar x "../$pkg" 2>/dev/null || true
              tar xzf data.tar.gz 2>/dev/null || tar xJf data.tar.xz 2>/dev/null || true
              # Copy libraries
              cp -rf usr/lib/* "../${STAGING_DIR}/usr/lib/" 2>/dev/null || true
              cp -rf lib/* "../${STAGING_DIR}/lib/" 2>/dev/null || true
              cd ..
              rm -rf tmp_extract
            fi
          done

          # Download and install header packages (development files)
          echo "Downloading header packages..."
          wget -q "${PKG_BASE}/libubox-dev_2024-09-16-9e52171d-1_mips_24kc.ipk" -O tmp_pkgs/libubox-dev.ipk || true
          wget -q "${PKG_BASE}/libubus-dev_2024-09-01-9913aa61-1_mips_24kc.ipk" -O tmp_pkgs/libubus-dev.ipk || true
          wget -q "${PKG_BASE}/libuci-dev_2024-10-10-c8d13d65-1_mips_24kc.ipk" -O tmp_pkgs/libuci-dev.ipk || true

          for pkg in tmp_pkgs/*-dev.ipk; do
            if [ -f "$pkg" ]; then
              echo "Extracting $pkg..."
              mkdir -p tmp_extract
              cd tmp_extract
              ar x "../$pkg" 2>/dev/null || true
              tar xzf data.tar.gz 2>/dev/null || tar xJf data.tar.xz 2>/dev/null || true
              cp -rf usr/include/* "../${STAGING_DIR}/usr/include/" 2>/dev/null || true
              cd ..
              rm -rf tmp_extract
            fi
          done

          # List what we have
          echo "Libraries installed:"
          ls -la "${STAGING_DIR}/usr/lib/" || true
          echo "Headers installed:"
          ls -la "${STAGING_DIR}/usr/include/" || true

      - name: Configure SDK
        run: |
          cd sdk
          # Disable default package selections
          cat >> .config << 'EOF'
          CONFIG_SIGNED_PACKAGES=n
          CONFIG_PACKAGE_nodewatcher-agent=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-general=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-resources=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-interfaces=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-wireless=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-keys_ssh=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-clients=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-http_push=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-routing_babel=m
          CONFIG_PACKAGE_nodewatcher-agent-mod-routing_olsr=m
          EOF
          make defconfig

      - name: Build packages
        run: |
          cd sdk
          make package/nodewatcher-agent/compile V=s -j$(nproc) || make package/nodewatcher-agent/compile V=s -j1

      - name: Collect packages
        run: |
          mkdir -p packages
          find sdk/bin -name "nodewatcher*.ipk" -exec cp {} packages/ \;
          ls -la packages/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nodewatcher-agent-packages-${{ env.TARGET }}-${{ env.SUBTARGET }}
          path: packages/*.ipk
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*.ipk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
